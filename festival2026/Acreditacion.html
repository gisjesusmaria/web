<!-- 25112025_1035 -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acreditaci√≥n Festival de Doma 2026</title>
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/gisjesusmaria/web/refs/heads/main/favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>


    <audio id="soundScan"    src="https://raw.githubusercontent.com/gisjesusmaria/web/main/sounds/scan-beep.mp3"    preload="auto"></audio>
    <audio id="soundSuccess" src="https://raw.githubusercontent.com/gisjesusmaria/web/main/sounds/success.mp3"      preload="auto"></audio>
    <audio id="soundError"   src="https://raw.githubusercontent.com/gisjesusmaria/web/main/sounds/error-buzz.mp3"   preload="auto"></audio>    


    <script>

    function playSound(id) {
        try {
            const audio = document.getElementById(id);
            if (!audio) return;


            audio.currentTime = 0;

            const p = audio.play();
            if (p && typeof p.catch === 'function') {
                p.catch(() => {

                });
            }
        } catch (e) {
            console.error('Error al reproducir sonido', e);
        }
    }
    </script>


    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .logo-container {
            margin-bottom: 20px;
        }

        .logo-container img {
            max-width: 400px;
            height: auto;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header h1 .emoji {
            font-size: 1.3em;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .form-container {
            padding: 40px 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        input[type="tel"],
        input[type="email"],
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        input[type="tel"]:focus,
        input[type="email"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            margin-top: 2px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .checkbox-item input[type="checkbox"]:checked + label {
            color: #667eea;
            font-weight: 600;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            flex: 1;
        }

        .sub-options {
            margin-left: 30px;
            margin-top: 10px;
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .sub-options.active {
            display: flex;
        }

        .sub-option-item {
            display: flex;
            align-items: flex-start;
            padding: 10px;
            background: #f8f9ff;
            border: 2px solid #e8eaf6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sub-option-item:hover {
            border-color: #667eea;
            background: #fff;
        }

        .sub-option-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            margin-top: 2px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .sub-option-item label {
            margin: 0;
            cursor: pointer;
            font-size: 0.95em;
            flex: 1;
        }

        .dominios-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 10px;
        }

        .dominios-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }




        .btn-consult {
            background: #4CAF50;
            color: white;
            padding: 14px 26px;        
            border: none;
            border-radius: 10px;
            font-size: 1.15em;         
            font-weight: 700;          
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
            float: right;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }


        .btn-consult:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-download {
            background: #2196F3;
            color: white;
        }

        .btn-download:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .clearfix::after {
            content: "";
            display: table;
            clear: both;
        }

        .success-container {
            display: none;
            text-align: center;
            padding: 40px 30px;
        }

        .success-container.active {
            display: block;
        }

        .success-icon {
            font-size: 4em;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .success-container h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .success-container p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }


        .credential-card {
            background: white !important;
            padding: 40px !important;
            border-radius: 20px !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
        }

        .credential-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .credential-header img {
            max-width: 250px;
            margin-bottom: 15px;
        }

        .credential-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .credential-field {
            background: #f8f9ff;
            padding: 12px;
            border-radius: 8px;
        }

        .credential-field strong {
            color: #667eea;
            display: block;
            font-size: 0.85em;
            margin-bottom: 5px;
        }


        .credential-field span {
            color: #333;
            font-size: 1.25em;        
            font-weight: 600;         
        }

        .credential-field strong {
            color: #667eea;
            display: block;
            font-size: 0.9em;         
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }


        .credential-header h3 {
            font-size: 1.6em;
            font-weight: 700;
            color: #333;
            margin-top: 15px;
        }


        .qr-section {
            text-align: center;
            margin: 30px 0;
        }

        #qrcode, #qrcodeConsult {
            display: inline-block !important;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .buttons-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .consult-container {
            display: none;
            padding: 40px 30px;
        }

        .consult-container.active {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            display: none;
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #c62828;
        }

        .error-message.active {
            display: block;
        }

        @media (max-width: 600px) {
            .header h1 { font-size: 1.5em; }
            .form-container { padding: 30px 20px; }
            .credential-info { grid-template-columns: 1fr; }
            .buttons-container { grid-template-columns: 1fr; }
            .logo-container img { max-width: 280px; }
        }

        .inactive-title {
            color: #c62828 !important;
            font-weight: bold;
        }   
        
        
        
        @media (max-width: 768px) {
            
            #consultResultContainer,
            #successContainer {
                overflow-x: hidden !important;
                padding: 10px !important;
            }

            .credential-card {
                width: 100% !important;
                max-width: 380px !important;     
                margin: 10px auto !important;
                padding: 20px 15px !important;
                box-sizing: border-box !important;
                border-radius: 16px !important;
                box-shadow: 0 8px 25px rgba(0,0,0,0.25) !important;
                background: white !important;
                transform: scale(0.94);           
                transform-origin: top center;
            }

            
            .credential-info {
                display: flex !important;
                flex-direction: column !important;
                gap: 11px !important;
                font-size: 14.5px !important;     
                line-height: 1.4 !important;
            }

            .credential-field span {
                font-size: 15.5px !important;
                font-weight: 600 !important;
                word-break: break-all !important;
            }

            
            #qrcode,
            #qrcodeConsult {
                text-align: center !important;
                margin: 20px auto !important;
                padding: 10px !important;
                background: white !important;
                border-radius: 14px !important;
                box-shadow: 0 4px 15px rgba(0,0,0,0.15) !important;
            }

            #qrcode img,
            #qrcodeConsult img {
                width: 210px !important;
                height: 210px !important;
                max-width: 68vw !important;
                image-rendering: -webkit-optimize-contrast; 
            }

            
            #btnLeerQR {
                width: 92% !important;
                max-width: 360px !important;
                margin: 15px auto !important;
                display: block !important;
                font-size: 1.3em !important;
            }
        }


        
        #qr-reader__scan_region {
            border-radius: 16px;
            overflow: hidden;
        }


       
        #qr-reader button[id^="html5-qrcode-button"],
        #qr-reader a#html5-qrcode-anchor-scan-type-change {
            padding: 10px 18px;
            border-radius: 999px;
            border: none;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin: 4px;
            text-decoration: none;
        }

        
        #qr-reader #html5-qrcode-button-camera-start,
        #qr-reader #html5-qrcode-button-camera-permission {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        
        #qr-reader #html5-qrcode-button-camera-stop,
        #qr-reader #html5-qrcode-button-file-selection,
        #qr-reader #html5-qrcode-anchor-scan-type-change {
            background: #f5f5f5;
            color: #333;
        }


        
        #qr-reader__scan_region img {
            display: none !important;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/gisjesusmaria/web/refs/heads/main/Logos/Logo01ConFondoWide.png" alt="Municipalidad de Jes√∫s Mar√≠a">
            </div>
            
            <h1><span class="emoji">üèá</span> Festival de Doma 2026</h1>
            <p>Municipalidad de Jes√∫s Mar√≠a - Acreditaci√≥n</p>
        </div>

        <div class="form-container" id="formContainer">
            <div class="clearfix">
                <button type="button" class="btn-consult" id="btnConsultar">Consultar Acreditaci√≥n</button>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            
            <form id="acreditacionForm">
                <div class="form-group">
                    <label for="nombre">Nombre Completo *</label>
                    <input type="text" id="nombre" name="nombre" class="uppercase-input" required>
                </div>

                <div class="form-group">
                    <label for="cuil">CUIL *</label>
                    <input type="text" id="cuil" name="cuil" placeholder="XX-XXXXXXXX-X" maxlength="13" required>
                </div>

                <div class="form-group">
                    <label for="cargo">Cargo / Instituci√≥n *</label>
                    <input type="text" id="cargo" name="cargo" class="uppercase-input" required>
                </div>

                <div class="form-group">
                    <label for="localidad">Localidad / Provincia / Pa√≠s *</label>
                    <input type="text" id="localidad" name="localidad" class="uppercase-input" required>
                </div>

                <div class="form-group">
                    <label for="dominio">Dominio del Veh√≠culo *</label>
                    <input type="text" id="dominio" name="dominio" placeholder="ABC123" class="uppercase-input" required>
                </div>

                <div class="form-group">
                    <label for="fechaVisita">Fecha de Visita *</label>
                    <input type="date" id="fechaVisita" name="fechaVisita" required>
                </div>

                <div class="form-group">
                    <label>Experiencias de Inter√©s *</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="circuito1" name="circuitos" value="Festival desde adentro">
                            <label for="circuito1">Festival desde adentro 20 a 00 hs. (Charlas y recorridos con √°reas de Comercio, Gobierno y Seguridad)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="circuito2" name="circuitos" value="Experiencia Jes√∫s Mar√≠a">
                            <label for="circuito2">Experiencia Jes√∫s Mar√≠a 9 a 12 hs. (Recorridos tur√≠sticos)</label>
                        </div>
                        <div class="sub-options" id="subOptions">
                            <div class="sub-option-item">
                                <input type="checkbox" id="circuito3" name="subcircuitos" value="Rincones festivaleros">
                                <label for="circuito3">1. Rincones festivaleros</label>
                            </div>
                            <div class="sub-option-item">
                                <input type="checkbox" id="circuito4" name="subcircuitos" value="Rincones Jesu√≠ticos e hist√≥ricos">
                                <label for="circuito4">2. Rincones Jesu√≠ticos e hist√≥ricos</label>
                            </div>
                            <div class="sub-option-item">
                                <input type="checkbox" id="circuito5" name="subcircuitos" value="Rincones naturales">
                                <label for="circuito5">3. Rincones naturales (Parque del Oeste/ Riberas Este)</label>
                            </div>
                            <div class="sub-option-item">
                                <input type="checkbox" id="circuito6" name="subcircuitos" value="Bus regional">
                                <label for="circuito6">4. Bus regional (incluye a Colonia Caroya y Sinsacate)</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="cantidadAcompanantes">Cantidad de Acompa√±antes</label>
                    <input type="number" id="cantidadAcompanantes" name="cantidadAcompanantes" min="0" value="0">
                </div>

                <div class="dominios-section">
                    <h3>Dominios Adicionales (Opcional)</h3>
                    <div class="form-group">
                        <label for="dominioAdicional1">Dominio Adicional 1</label>
                        <input type="text" id="dominioAdicional1" name="dominioAdicional1" placeholder="ABC123" class="uppercase-input">
                    </div>
                    <div class="form-group">
                        <label for="dominioAdicional2">Dominio Adicional 2</label>
                        <input type="text" id="dominioAdicional2" name="dominioAdicional2" placeholder="ABC123" class="uppercase-input">
                    </div>
                    <div class="form-group">
                        <label for="dominioAdicional3">Dominio Adicional 3</label>
                        <input type="text" id="dominioAdicional3" name="dominioAdicional3" placeholder="ABC123" class="uppercase-input">
                    </div>
                </div>

                <div class="form-group">
                    <label for="telefono">Tel√©fono (10 d√≠gitos) *</label>
                    <small><em>Si su tel√©fono NO es l√≠nea de Argentina ingrese signo + y el n√∫mero, tal como lo tiene configurado en Whatsapp.</em></small>
                    <input type="tel" id="telefono" name="telefono" placeholder="3515123456" maxlength="16" required>
                </div>

                <div class="form-group">
                    <label for="mail">Email *</label>
                    <input type="email" id="mail" name="mail" placeholder="ejemplo@correo.com" required>
                </div>

                <button type="submit" class="btn btn-primary">Registrar Acreditaci√≥n</button>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Registrando sus datos...</p>
            </div>
        </div>

        <div class="success-container" id="successContainer">
            <div class="success-icon">‚úÖ</div>
            <h2>¬°Registro Exitoso!</h2>
            <p>Sus datos han sido registrados correctamente.</p>
            
            <div class="credential-card" id="credentialCard">
                <div class="credential-header">
                    <img src="https://raw.githubusercontent.com/gisjesusmaria/web/refs/heads/main/Logos/Logo01ConFondoWide.png" alt="Municipalidad" crossorigin="anonymous">
                    <h3>Acreditaci√≥n Festival de Doma 2026</h3>
                </div>
                <div class="credential-info" id="credentialInfo"></div>
                <div class="qr-section">
                    <div id="qrcode"></div>
                </div>
            </div>
            
            <div class="buttons-container">
                <button class="btn btn-download" id="downloadImage">üì∑ Descargar Imagen</button>
                <button class="btn btn-download" id="downloadPDF">üìÑ Descargar PDF</button>                
            </div>
            <button class="btn btn-primary" id="newRegistration" style="margin-top: 10px;">Nueva Inscripci√≥n</button>
        </div>

        <div class="consult-container" id="consultContainer">
            <h2 style="text-align: center; color: #333; margin-bottom: 30px;">Consultar Acreditaci√≥n</h2>

            <div style="text-align: center; margin-bottom: 20px;">

                <button type="button" class="btn btn-secondary" id="btnLeerQR" style="padding: 14px 30px; font-size: 1.2em; background: #FF5722 !important; box-shadow: 0 4px 15px rgba(255,87,34,0.5);">
                    Escanear QR
                </button>         

            </div>

            
            <div id="qr-reader" style="width: 100%; max-width: 500px; margin: 20px auto; display: none;"></div>

           
            <input type="file" id="qr-image-input" accept="image/*" style="display:none">

            <div id="qr-result" style="text-align: center; margin: 15px 0; font-weight: bold; color: #c62828;"></div>
            
            

            <div class="error-message" id="errorMessageConsult"></div>
            
            <form id="consultForm">
                <div class="form-group">
                    <label for="cuilConsulta">CUIL *</label>
                    <input type="text" id="cuilConsulta" name="cuilConsulta" placeholder="XX-XXXXXXXX-X" maxlength="13" required>
                </div>

                <div class="form-group">
                    <label for="fechaConsulta">Fecha de Visita *</label>
                    <input type="date" id="fechaConsulta" name="fechaConsulta" required>
                </div>

                <button type="submit" class="btn btn-primary">Buscar Acreditaci√≥n</button>
                <button type="button" class="btn btn-secondary" id="btnVolver" style="margin-top: 10px;">Volver al Formulario</button>
            </form>

            <div class="loading" id="loadingConsult">
                <div class="spinner"></div>
                <p>Buscando acreditaci√≥n...</p>
            </div>
        </div>

        <div class="success-container" id="consultResultContainer">
            
            <div class="success-icon">‚úÖ</div>
            <h2>Acreditaci√≥n Encontrada</h2>
            
            <div class="credential-card" id="consultCredentialCard">
                <div class="credential-header">
                    <img src="https://raw.githubusercontent.com/gisjesusmaria/web/refs/heads/main/Logos/Logo01ConFondoWide.png" alt="Municipalidad" crossorigin="anonymous">
                    <h3>Acreditaci√≥n Festival de Doma 2026</h3>
                </div>
                <div class="credential-info" id="consultCredentialInfo"></div>
                <div class="qr-section">
                    <div id="qrcodeConsult"></div>
                </div>
            </div>
            
            <div class="buttons-container">
                <button class="btn btn-download" id="downloadImageConsult">üì∑ Descargar Imagen</button>
                <button class="btn btn-download" id="downloadPDFConsult">üìÑ Descargar PDF</button>                
            </div>
            <button class="btn btn-primary" id="newConsult" style="margin-top: 10px;">Nueva Consulta</button>
        </div>
    </div>

    <script>
        const form = document.getElementById('acreditacionForm');
        const formContainer = document.getElementById('formContainer');
        const successContainer = document.getElementById('successContainer');
        const consultContainer = document.getElementById('consultContainer');
        const consultResultContainer = document.getElementById('consultResultContainer');
        const loading = document.getElementById('loading');
        const loadingConsult = document.getElementById('loadingConsult');
        const errorMessage = document.getElementById('errorMessage');
        const errorMessageConsult = document.getElementById('errorMessageConsult');



        const SCRIPT_URL = "https://acreditacion.gisjesusmaria.workers.dev"

        

        let currentFormData = null;


        document.querySelectorAll('.uppercase-input').forEach(input => {
            input.addEventListener('input', function() {
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.toUpperCase();
                this.setSelectionRange(start, end);
            });
        });


        function setupCuilFormat(id) {
            const input = document.getElementById(id);
            input.addEventListener('input', function() {
                let v = this.value.replace(/\D/g, '');
                if (v.length > 11) v = v.substring(0,11);
                let f = '';
                if (v.length > 0) f = v.substring(0,2);
                if (v.length > 2) f += '-' + v.substring(2,10);
                if (v.length > 10) f += '-' + v.substring(10,11);
                this.value = f;
            });
        }
        setupCuilFormat('cuil');
        setupCuilFormat('cuilConsulta');

  
        document.getElementById('telefono').addEventListener('input', function() {
            let v = this.value.trim();

            const hasPlus = v.startsWith('+');

            if (hasPlus) {
                let digits = v.slice(1).replace(/\D/g, '');
                digits = digits.substring(0, 15);
                v = '+' + digits;
            } else {
                v = v.replace(/\D/g, '').substring(0, 10);
            }

            this.value = v;

            const digitsCount = hasPlus ? v.length - 1 : v.length;

            if (hasPlus) {
                if (digitsCount >= 11) {
                    this.setCustomValidity('');
                } else {
                    this.setCustomValidity('Con el signo + debe ingresar al menos 11 d√≠gitos num√©ricos.');
                }
            } else {
                if (digitsCount === 10) {
                    this.setCustomValidity('');
                } else {
                    this.setCustomValidity('El tel√©fono debe contener exactamente 10 d√≠gitos num√©ricos sin el signo +.');
                }
            }
        });


        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fechaVisita').min = today;
        document.getElementById('fechaConsulta').min = today;


        document.getElementById('circuito2').addEventListener('change', function() {
            document.getElementById('subOptions').classList.toggle('active', this.checked);
            if (!this.checked) document.querySelectorAll('input[name="subcircuitos"]').forEach(cb => cb.checked = false);
        });


        document.getElementById('btnConsultar').onclick = () => {
            formContainer.style.display = 'none';
            consultContainer.classList.add('active');


            document.getElementById('qr-result').textContent = '';            
        };


        document.getElementById('btnVolver').onclick = () => {
            consultContainer.classList.remove('active');
            formContainer.style.display = 'block';
            document.getElementById('consultForm').reset();
            errorMessageConsult.classList.remove('active');


            document.getElementById('qr-result').textContent = '';

        };


        function formatDate(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
        }



        function generateQR(container, cuil, fecha) {
            container.innerHTML = '';
            const qrText = `${cuil},${fecha}`;
            
            new QRCode(container, {
                text: qrText,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });


            setTimeout(() => {
                const canvas = container.querySelector('canvas');
                if (canvas) {
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL('image/png');
                    img.style.width = '256px';
                    img.style.height = '256px';
                    img.style.borderRadius = '15px';
                    img.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
                    img.style.background = 'white';
                    img.style.padding = '20px';
                    container.innerHTML = '';
                    container.appendChild(img);
                }
            }, 200);
        }        

        function showCredential(data, infoId, qrId) {
            const info = document.getElementById(infoId);
            const fecha = formatDate(data.fechaVisita);


            const dom1 = data.dominio || '';
            const domAd1 = data.dominioAdicional1 || '';
            const domAd2 = data.dominioAdicional2 || '';
            const domAd3 = data.dominioAdicional3 || '';

            info.innerHTML = `
                <div class="credential-field"><strong>CUIL:</strong><span>${data.cuil}</span></div>
                <div class="credential-field"><strong>Nombre:</strong><span>${data.nombre}</span></div>
                <div class="credential-field"><strong>Cargo/Instituci√≥n:</strong><span>${data.cargo}</span></div>
                <div class="credential-field"><strong>Localidad:</strong><span>${data.localidad}</span></div>
                <div class="credential-field"><strong>Dominio:</strong><span>${dom1 || '-'}</span></div>
                <div class="credential-field"><strong>Dominio Adicional 1:</strong><span>${domAd1 || '-'}</span></div>
                <div class="credential-field"><strong>Dominio Adicional 2:</strong><span>${domAd2 || '-'}</span></div>
                <div class="credential-field"><strong>Dominio Adicional 3:</strong><span>${domAd3 || '-'}</span></div>
                <div class="credential-field"><strong>Fecha de Visita:</strong><span>${fecha}</span></div>
            `;
            setTimeout(() => generateQR(document.getElementById(qrId), data.cuil, fecha), 100);
        }



        form.addEventListener('submit', async e => {
            e.preventDefault();
            errorMessage.classList.remove('active');

            if (document.querySelectorAll('input[name="circuitos"]:checked').length === 0) {
                errorMessage.textContent = 'Por favor, seleccione al menos una experiencia de inter√©s.';
                errorMessage.classList.add('active');
                return;
            }
            
            const telefonoInput = document.getElementById('telefono');
            let rawTel = telefonoInput.value.trim();
            const hasPlus = rawTel.startsWith('+');


            let digits = hasPlus
                ? rawTel.slice(1).replace(/\D/g, '')
                : rawTel.replace(/\D/g, '');

            if (hasPlus) {

                if (digits.length < 11) {
                    telefonoInput.setCustomValidity('Con el signo + no puede ingresar menos de 11 d√≠gitos.');
                    telefonoInput.reportValidity();
                    errorMessage.textContent = 'Con el signo + no puede ingresar menos de 11 d√≠gitos.';
                    errorMessage.classList.add('active');
                    return;
                }

                digits = digits.substring(0, 15);
                telefonoInput.value = '+' + digits;
            } else {

                if (digits.length !== 10) {
                    telefonoInput.setCustomValidity('El tel√©fono debe contener exactamente 10 d√≠gitos num√©ricos sin el signo +.');
                    telefonoInput.reportValidity();
                    errorMessage.textContent = 'El tel√©fono debe contener exactamente 10 d√≠gitos num√©ricos sin el signo +.';
                    errorMessage.classList.add('active');
                    return;
                }
                telefonoInput.value = digits.substring(0, 10);
            }


            telefonoInput.setCustomValidity('');
            errorMessage.classList.remove('active');



            const email = document.getElementById('mail').value.trim();
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                errorMessage.textContent = 'Por favor, ingrese un email v√°lido.';
                errorMessage.classList.add('active');
                return;
            }

            currentFormData = {
                nombre: document.getElementById('nombre').value,
                cuil: document.getElementById('cuil').value,
                cargo: document.getElementById('cargo').value,
                localidad: document.getElementById('localidad').value,
                dominio: document.getElementById('dominio').value,
                fechaVisita: document.getElementById('fechaVisita').value,
                circuito1: document.getElementById('circuito1').checked ? 'SI' : 'NO',
                circuito3: document.getElementById('circuito3').checked ? 'SI' : 'NO',
                circuito4: document.getElementById('circuito4').checked ? 'SI' : 'NO',
                circuito5: document.getElementById('circuito5').checked ? 'SI' : 'NO',
                circuito6: document.getElementById('circuito6').checked ? 'SI' : 'NO',
                cantidadAcompanantes: document.getElementById('cantidadAcompanantes').value || '0',
                dominioAdicional1: document.getElementById('dominioAdicional1').value || '',
                dominioAdicional2: document.getElementById('dominioAdicional2').value || '',
                dominioAdicional3: document.getElementById('dominioAdicional3').value || '',
                //telefono: tel,
                telefono: telefonoInput.value,
                mail: email
            };

            form.style.display = 'none';
            loading.classList.add('active');
            
            document.getElementById('btnConsultar').style.display = 'none';

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentFormData)
                });




                setTimeout(() => {
                    loading.classList.remove('active');
                    formContainer.style.display = 'none';
                    successContainer.classList.add('active');
                    document.getElementById('btnConsultar').style.display = 'block';


                    setTimeout(() => showCredential(currentFormData, 'credentialInfo', 'qrcode'), 100);

                    const cuil = currentFormData.cuil;
                    const fechaSinFormato = currentFormData.fechaVisita; 
                    const email = currentFormData.mail;


                    const fechaParts = fechaSinFormato.split('-');
                    const fecha = `${fechaParts[2]}/${fechaParts[1]}/${fechaParts[0]}`;

                    fetch(`${SCRIPT_URL}?action=enviarPorCuilYFecha&cuil=${encodeURIComponent(cuil)}&fecha=${encodeURIComponent(fecha)}&email=${encodeURIComponent(email)}`)
                        .then(r => r.json())
                        .then(res => {
                            if (res && res.status === "success") {

                                const notification = document.createElement('div');
                                notification.textContent = "¬°Acreditaci√≥n enviada a tu correo!";
                                notification.style.cssText = `
                                    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                                    background: #4CAF50; color: white; padding: 12px 30px;
                                    border-radius: 30px; font-weight: bold; z-index: 9999;
                                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                                `;
                                document.body.appendChild(notification);
                                setTimeout(() => notification.remove(), 5000);
                            }
                        })
                        .catch(err => {
                            console.log("No se pudo enviar el mail (puede ser normal en algunos casos)", err);
                        });

                }, 1500);



            } catch(err) {
                loading.classList.remove('active');
                form.style.display = 'block';

                document.getElementById('btnConsultar').style.display = 'block';

                errorMessage.textContent = 'Error al registrar. Intente nuevamente.';
                errorMessage.classList.add('active');
            }
        });


        document.getElementById('consultForm').addEventListener('submit', async e => {
            e.preventDefault();
            errorMessageConsult.classList.remove('active');

            const cuil = document.getElementById('cuilConsulta').value;
            const fecha = document.getElementById('fechaConsulta').value;

            document.getElementById('consultForm').style.display = 'none';
            loadingConsult.classList.add('active');

            try {
                const url = `${SCRIPT_URL}?action=consultar&cuil=${encodeURIComponent(cuil)}&fechaVisita=${encodeURIComponent(fecha)}`;
                const res = await fetch(url);
                const result = await res.json();

                loadingConsult.classList.remove('active');

                if (result.success && result.found) {
                    currentFormData = result.data;


                    if (result.data.activo === "1" || result.data.activo === 1) {

                        document.getElementById('consultResultContainer').querySelector('h2').textContent = "Acreditaci√≥n Activa"; 
                        document.getElementById('consultResultContainer').querySelector('.success-icon').textContent = "‚úÖ"; 
                        document.getElementById('consultResultContainer').querySelector('.success-icon').style.color = "#4CAF50";

                        showCredential(result.data, 'consultCredentialInfo', 'qrcodeConsult');


                        document.querySelectorAll('#downloadImageConsult, #downloadPDFConsult').forEach(btn => {
                            btn.style.display = 'block';
                            btn.disabled = false;
                        });

                        playSound('soundSuccess');   

                    } else {

                        document.getElementById('consultResultContainer').querySelector('h2').textContent = "ACREDITACI√ìN INACTIVA";
                        document.getElementById('consultResultContainer').querySelector('.success-icon').textContent = "‚ùå";
                        document.getElementById('consultResultContainer').querySelector('.success-icon').style.color = "#c62828";


                        const info = document.getElementById('consultCredentialInfo');
                        const fecha = formatDate(result.data.fechaVisita);


                        info.innerHTML = `
                            <div class="credential-field"><strong>CUIL:</strong><span>${result.data.cuil}</span></div>
                            <div class="credential-field"><strong>Nombre:</strong><span>${result.data.nombre}</span></div>
                            <div class="credential-field"><strong>Cargo/Instituci√≥n:</strong><span>${result.data.cargo}</span></div>
                            <div class="credential-field"><strong>Localidad:</strong><span>${result.data.localidad}</span></div>
                            <div class="credential-field"><strong>Dominio:</strong><span>${result.data.dominio || '-'}</span></div>
                            <div class="credential-field"><strong>Dominio Adicional 1:</strong><span>${result.data.dominioAdicional1 || '-'}</span></div>
                            <div class="credential-field"><strong>Dominio Adicional 2:</strong><span>${result.data.dominioAdicional2 || '-'}</span></div>
                            <div class="credential-field"><strong>Dominio Adicional 3:</strong><span>${result.data.dominioAdicional3 || '-'}</span></div>
                            <div class="credential-field"><strong>Fecha de Visita:</strong><span>${fecha}</span></div>
                            <div class="credential-field" style="background:#ffebee;color:#c62828;font-weight:bold;">
                                <strong>ESTADO:</strong><span>INACTIVA</span>
                            </div>
                        `;                        


                        document.getElementById('qrcodeConsult').innerHTML = '';
                        document.querySelectorAll('#downloadImageConsult, #downloadPDFConsult').forEach(btn => {
                            btn.style.display = 'none';
                        });

                        playSound('soundError');   

                    }

                    consultContainer.classList.remove('active');
                    consultResultContainer.classList.add('active');

                } else {
                    document.getElementById('consultForm').style.display = 'block';
                    errorMessageConsult.textContent = result.message || 'No se encontr√≥ la acreditaci√≥n.';
                    errorMessageConsult.classList.add('active');
                }
            } catch(err) {
                loadingConsult.classList.remove('active');
                document.getElementById('consultForm').style.display = 'block';
                errorMessageConsult.textContent = 'Error al buscar la acreditaci√≥n.';
                errorMessageConsult.classList.add('active');
            }
        });


        async function capture(cardId) {

            await new Promise(resolve => setTimeout(resolve, 1000)); 
            
            const card = document.getElementById(cardId);
            

            const canvas = await html2canvas(card, {
                scale: 2,
                useCORS: true,           
                allowTaint: false,
                backgroundColor: '#ffffff',
                logging: false,

                onclone: function (clonedDoc) {

                    const qrElements = clonedDoc.querySelectorAll('#qrcode, #qrcodeConsult');
                    qrElements.forEach(el => {
                        if (el.children.length === 0 && el.dataset.qrText) {
                            new QRCode(el, {
                                text: el.dataset.qrText,
                                width: 256,
                                height: 256,
                                colorDark: "#000000",
                                colorLight: "#ffffff",
                                correctLevel: QRCode.CorrectLevel.H
                            });
                        }
                    });
                }
            });
            return canvas;
        }

        async function downloadAsImage(cardId, filename) {
            await new Promise(r => setTimeout(r, 1200));

            const card = document.getElementById(cardId);
            const infoGrid = card.querySelector('.credential-info');


            const originalCardStyle = card.style.cssText;
            const originalInfoStyle = infoGrid.style.cssText;


            card.style.cssText = `
                width: 600px !important;
                max-width: none !important;
                margin: 0 auto !important;
                padding: 40px !important;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
            `;
            infoGrid.style.cssText = `
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 18px !important;
            `;

            const canvas = await html2canvas(card, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                width: 600,
                logging: false
            });


            card.style.cssText = originalCardStyle;
            infoGrid.style.cssText = originalInfoStyle;

            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }


        

        async function downloadAsPDF(cardId, filename) {
            await new Promise(r => setTimeout(r, 1300)); 

            const card = document.getElementById(cardId);
            const infoGrid = card.querySelector('.credential-info');


            const originalCardStyle = card.style.cssText;
            const originalInfoStyle = infoGrid.style.cssText;


            card.style.cssText = `
                width: 620px !important;
                max-width: none !important;
                margin: 0 auto !important;
                padding: 40px !important;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
                background: white !important;
            `;
            infoGrid.style.cssText = `
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 18px !important;
            `;

            const canvas = await html2canvas(card, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                width: 620,
                height: card.offsetHeight + 100, 
                logging: false
            });


            card.style.cssText = originalCardStyle;
            infoGrid.style.cssText = originalInfoStyle;


            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();

            const margin = 15;
            const maxWidth = pageWidth - 2 * margin;
            const maxHeight = pageHeight - 2 * margin;

            const imgWidth = canvas.width / 2;   
            const imgHeight = canvas.height / 2;

            
            const ratio = Math.min(maxWidth / imgWidth, maxHeight / imgHeight);
            const finalWidth = imgWidth * ratio;
            const finalHeight = imgHeight * ratio;

            
            const x = (pageWidth - finalWidth) / 2;
            const y = (pageHeight - finalHeight) / 2;

            pdf.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
            pdf.save(filename);
        }


        
        document.getElementById('downloadImage').onclick = () => 
            downloadAsImage('credentialCard', `Acreditacion_${currentFormData.cuil.replace(/[^\w]/g,'_')}.png`);
        document.getElementById('downloadPDF').onclick = () => 
            downloadAsPDF('credentialCard', `Acreditacion_${currentFormData.cuil.replace(/[^\w]/g,'_')}.pdf`);
        document.getElementById('downloadImageConsult').onclick = () => 
            downloadAsImage('consultCredentialCard', `Acreditacion_${currentFormData.cuil.replace(/[^\w]/g,'_')}.png`);
        document.getElementById('downloadPDFConsult').onclick = () => 
            downloadAsPDF('consultCredentialCard', `Acreditacion_${currentFormData.cuil.replace(/[^\w]/g,'_')}.pdf`);


        
        document.getElementById('newRegistration').onclick = () => {
            form.reset();
            successContainer.classList.remove('active');
            formContainer.style.display = 'block';
            form.style.display = 'block';
        };
        document.getElementById('newConsult').onclick = () => {
            document.getElementById('consultForm').reset();
            consultResultContainer.classList.remove('active');
            consultContainer.classList.add('active');
            document.getElementById('consultForm').style.display = 'block';


            document.getElementById('qr-result').textContent = '';
            

            if (scannerActive) {
                document.getElementById('btnLeerQR').click();
            }            
        };




        let scannerActive = false;
        let html5QrcodeScanner = null;

        let qrUiTranslatorInterval = null;


        function handleDecodedFromQr(decodedText) {
            const readerDiv = document.getElementById('qr-reader');
            const resultDiv = document.getElementById('qr-result');
            const btnLeer   = document.getElementById('btnLeerQR');


            playSound('soundScan');


            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch(() => {});
                html5QrcodeScanner = null;
            }



            if (qrUiTranslatorInterval) {
                clearInterval(qrUiTranslatorInterval);
                qrUiTranslatorInterval = null;
            }


            readerDiv.style.display = 'none';
            btnLeer.textContent = 'Escanear QR';
            scannerActive = false;


            const parts = decodedText.trim().split(',');
            if (parts.length !== 2) {
                resultDiv.textContent = 'C√≥digo QR de acreditaci√≥n inv√°lido';
                resultDiv.style.color = '#c62828';
                playSound('soundError');
                return;
            }

            const cuil = parts[0].trim();
            const fechaStr = parts[1].trim();


            if (!/^(\d{2}-)?\d{8}-\d$/.test(cuil) && !/^\d{11}$/.test(cuil.replace(/[^\d]/g,''))) {
                resultDiv.textContent = 'CUIL no v√°lido en el QR';
                resultDiv.style.color = '#c62828';
                playSound('soundError');
                return;
            }


            const fechaParts = fechaStr.split('/');
            if (fechaParts.length !== 3 || fechaParts[0].length !== 2 || fechaParts[1].length !== 2 || fechaParts[2].length !== 4) {
                resultDiv.textContent = 'Fecha no v√°lida en el QR';
                resultDiv.style.color = '#c62828';
                playSound('soundError');
                return;
            }
            const fechaISO = `${fechaParts[2]}-${fechaParts[1]}-${fechaParts[0]}`;


            document.getElementById('cuilConsulta').value  = cuil;
            document.getElementById('fechaConsulta').value = fechaISO;

            resultDiv.textContent = '¬°QR le√≠do! Buscando...';
            resultDiv.style.color = '#4CAF50';


            setTimeout(() => {
                const submitBtn = document.querySelector('#consultForm button[type="submit"]');
                if (submitBtn) submitBtn.click();
            }, 800);
        }


        function beautifyQrUi() {
            const readerDiv = document.getElementById('qr-reader');
            if (!readerDiv) return;

            const btnPerm = readerDiv.querySelector('#html5-qrcode-button-camera-permission');
            const btnStart = readerDiv.querySelector('#html5-qrcode-button-camera-start');
            const btnStop = readerDiv.querySelector('#html5-qrcode-button-camera-stop');
            const btnFile = readerDiv.querySelector('#html5-qrcode-button-file-selection');
            const scanTypeLink = readerDiv.querySelector('#html5-qrcode-anchor-scan-type-change');

            if (btnPerm) btnPerm.textContent = 'Habilitar c√°mara';
            if (btnStart) btnStart.textContent = 'Iniciar escaneo';
            if (btnStop) btnStop.textContent = 'Detener escaneo';
            if (btnFile) btnFile.textContent = 'Escanear desde imagen';
            if (scanTypeLink) scanTypeLink.textContent = 'Cambiar modo';


        }


        document.getElementById('btnLeerQR').addEventListener('click', function() {
            const readerDiv = document.getElementById('qr-reader');
            const resultDiv = document.getElementById('qr-result');

            resultDiv.textContent = '';


            if (scannerActive) {
                if (html5QrcodeScanner) {
                    html5QrcodeScanner.clear().catch(() => {});
                    html5QrcodeScanner = null;
                }
                readerDiv.style.display = 'none';
                this.textContent = 'Escanear QR';
                scannerActive = false;


                if (qrUiTranslatorInterval) {
                    clearInterval(qrUiTranslatorInterval);
                    qrUiTranslatorInterval = null;
                }

                return;
            }


            readerDiv.style.display = 'block';
            this.textContent = 'Cancelar escaneo';
            scannerActive = true;

            html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader",
                { fps: 10, qrbox: { width: 300, height: 300 } },
                false
            );

            html5QrcodeScanner.render(
                (decodedText) => {
                    handleDecodedFromQr(decodedText);
                },
                (error) => {

                }
            );


            setTimeout(beautifyQrUi, 500);

            traducirUiQr();  
            qrUiTranslatorInterval = setInterval(traducirUiQr, 500);      

        });

        
        document.getElementById('qr-reader').addEventListener('click', function(e) {
            if (e.target === this && scannerActive) {
                document.getElementById('btnLeerQR').click();
            }
        });


        
        function traducirUiQr() {
            const readerDiv = document.getElementById('qr-reader');
            if (!readerDiv) return;

        
            const btnPerm    = readerDiv.querySelector('#html5-qrcode-button-camera-permission');
            const btnStart   = readerDiv.querySelector('#html5-qrcode-button-camera-start');
            const btnStop    = readerDiv.querySelector('#html5-qrcode-button-camera-stop');
            const btnFile    = readerDiv.querySelector('#html5-qrcode-button-file-selection');
            const scanType   = readerDiv.querySelector('#html5-qrcode-anchor-scan-type-change');

            if (btnPerm)  btnPerm.textContent  = 'Habilitar c√°mara';
            if (btnStart) btnStart.textContent = 'Iniciar escaneo';
            if (btnStop)  btnStop.textContent  = 'Detener escaneo';
            if (btnFile)  btnFile.textContent  = 'Elegir imagen';
            if (scanType) scanType.textContent = 'Cambiar modo';

        
            const allControls = readerDiv.querySelectorAll('button, a');

            allControls.forEach(el => {
                const t = (el.textContent || '').trim().toLowerCase();

                if (/start scanning/.test(t)) {
                    el.textContent = 'Iniciar escaneo';
                } else if (/stop scanning/.test(t)) {
                    el.textContent = 'Detener escaneo';
                } else if (/request camera permissions/.test(t)) {
                    el.textContent = 'Habilitar c√°mara';
                } else if (/scan an image file/.test(t) || /choose image/.test(t) || /image file/.test(t)) {
                    el.textContent = 'Elegir imagen';
                }
            });
        }


    </script>
</body>
</html>