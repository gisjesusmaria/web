<!-- 27112025_0939 -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fichajes Festival Doma 2026</title>
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/gisjesusmaria/web/refs/heads/main/favicon.ico">


    <style>
        html, body {
            margin: 0;
            padding: 0;
            background: #f3f3f1;
            font-family: Arial, sans-serif;
            min-height: 100vh;
        }
        body {
            text-align: center;
            color: #000;
            padding: 20px 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-size: clamp(28px, 6vw, 50px);
            margin: 10px 0;
            color: #fa802f;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        #date {
            font-size: clamp(20px, 4.5vw, 32px);
            margin: 8px 0;
            font-weight: bold;
        }
        #time {
            font-size: clamp(36px, 10vw, 80px);
            font-weight: bold;
            margin: 10px 0;
            color: #0525f7;
        }

        #toggleBtn {
            padding: 15px 40px;
            font-size: clamp(20px, 5vw, 32px);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            margin: 20px 0;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .green {background:#0b0;}
        .red {background:#c00;}

        .input-group {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 0;
        }
        #dniInput {
            padding: 14px;
            font-size: clamp(18px, 4vw, 24px);
            width: 240px;
            max-width: 60vw;
            text-align: center;
            border: 3px solid #333;
            border-right: none;
            border-radius: 12px 0 0 12px;
            background: white;
        }
        #searchBtn {
            background: #333;
            color: white;
            padding: 14px 18px;
            border: none;
            border-radius: 0 12px 12px 0;
            cursor: pointer;
            font-size: clamp(20px, 5vw, 28px);
        }

        #statusMessage {
            font-size: clamp(20px, 4.5vw, 28px);
            font-weight: bold;
            margin: 15px 0;
            min-height: 40px;
            color: #0066cc;
        }
        


        
        #spinnerant {
            display: none;
            margin: 25px 0;
        }
        #spinnerant svg {
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }


        #spinner {
            display: none;
            margin: 30px 0;
        }
        #spinner svg {
            width: 120px;      /* ← antes era 50px */
            height: 120px;     /* ← antes era 50px */
            animation: spin 1.2s linear infinite;
        }
        #spinner div {
            margin-top: 15px;
            font-size: 26px;   /* ← texto más grande */
            font-weight: bold;
            color: #0066cc;
        }


        #employeeInfo {
            font-size: clamp(18px, 4.5vw, 26px);
            background: white;
            padding: 20px;
            border-radius: 3px solid #333;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 90%;
            display: none;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-weight: bold;
        }
        canvas {
            border: 4px solid #333;
            background: #fff;
            width: 90vw;
            max-width: 420px;
            height: 180px;
            touch-action: none;
            margin: 25px auto;
            display: block;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .btn-group {
            margin: 20px 0 40px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
            width: 100%;
            max-width: 420px;
        }
        #clearBtn, #ficharBtn {
            padding: 14px 30px;
            font-size: clamp(18px, 4.5vw, 24px);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #clearBtn {
            background: #666;
            color: white;
            width: 80%;
            max-width: 300px;
        }
        #ficharBtn {
            background: #0066cc;
            color: white;
            font-size: clamp(26px, 7vw, 40px);
            letter-spacing: 8px;
            padding: 18px 40px;
            width: 90%;
            max-width: 380px;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* En pantallas grandes (PC) limitamos el ancho máximo para que no quede todo estirado */
        @media (min-width: 768px) {
            body { max-width: 600px; margin: 0 auto; padding-top: 30px; }
            canvas { width: 420px; height: 200px; }
        }


        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        #dniInput:disabled {
            opacity: 0.6;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

    </style>

</head>
<body>
    <!-- PANTALLA DE CARGA LIVIANA -->
    <div id="loadingOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(243,243,241,0.98);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.4s;">
        <img src="https://raw.githubusercontent.com/gisjesusmaria/web/refs/heads/main/Logos/Logo01ConFondoWide.png" style="width:70%;max-width:380px;margin-bottom:20px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.3);">
        <div style="font-size:26px;color:#0066cc;font-weight:bold;">Cargando sistema...</div>
        <div style="margin-top:20px;">
            <svg width="60" height="60" viewBox="0 0 50 50" style="animation:spin 1s linear infinite;">
                <circle cx="25" cy="25" r="20" fill="none" stroke="#0066cc" stroke-width="5" stroke-linecap="round" stroke-dasharray="90 150"/>
            </svg>
        </div>
    </div>


    <div style="margin: 15px auto 10px; text-align:center; max-width:90%;">
        <img src="https://raw.githubusercontent.com/gisjesusmaria/web/refs/heads/main/Logos/Logo01ConFondoWide.png" 
            alt="Municipalidad de Jesús María" 
            style="width:100%; max-width:420px; height:auto; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
    </div>


    <h1 id="title">Cargando...</h1>

    <!-- MENSAJE DE ESTADO (éxito o procesando) -->
    <div id="statusMessage" style="font-size:22px; font-weight:bold; margin:15px 0; min-height:30px; color:#0066cc;"></div>

    
    <!-- SPINNER (oculto por defecto) -->
    <div id="spinner" style="display:none; margin:20px 0;">
        <svg width="50" height="50" viewBox="0 0 50 50" style="animation: spin 1s linear infinite;">
            <circle cx="25" cy="25" r="20" fill="none" stroke="#0066cc" stroke-width="5" stroke-linecap="round" stroke-dasharray="90 150"/>
        </svg>
        <!-- <div style="margin-top:10px; font-size:18px; color:#0066cc;">Registrando fichaje...</div> -->
        <div style="margin-top:15px; font-size:26px; font-weight:bold; color:#0716eb;">Registrando fichaje...</div>
    </div>

    <div id="date"></div>
    <div id="time"></div>

    <button id="toggleBtn" class="green">ENTRADA</button>

    <div class="input-group">
        <input type="number" id="dniInput" placeholder="Ingrese DNI" autocomplete="off">
        <button id="searchBtn" title="Buscar">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </button>
    </div>


    <!-- SPINNER DE BÚSQUEDA (naranja) - APARECE CUANDO BUSCA EL DNI -->
    <div id="searchSpinner" style="display:none; margin:20px 0;">
        <svg width="60" height="60" viewBox="0 0 50 50" style="animation:spin 1.2s linear infinite;">
            <circle cx="25" cy="25" r="20" fill="none" stroke="#fa802f" stroke-width="5" stroke-linecap="round" stroke-dasharray="90 150"/>
        </svg>
        <div style="margin-top:10px; font-size:24px; font-weight:bold; color:#fa802f;">Buscando empleado...</div>
    </div>


    <div id="employeeInfo"></div>

    <canvas id="signaturePad" width="340" height="170"></canvas>

    <div class="btn-group">
        <button id="clearBtn">Borrar firma</button>
        <button id="ficharBtn">FICHAR</button>
    </div>

<script>
    let config = {};
    let scriptUrl = '';
    let mode = 'E';
    let employeeData = null;

    let deviceInfoGlobal = {};

    // RELOJ
    const updateClock = () => {
        const n = new Date();
        document.getElementById('date').textContent = `${String(n.getDate()).padStart(2,'0')}/${String(n.getMonth()+1).padStart(2,'0')}/${n.getFullYear()}`;
        document.getElementById('time').textContent = n.toTimeString().substr(0,8);
    };
    setInterval(updateClock, 1000); updateClock();



    // CARGAR CONFIG + BLOQUEO TOTAL HASTA QUE TERMINE
    async function loadConfig() {
        // ← BLOQUEAR TODO DESDE EL INICIO
        document.body.style.pointerEvents = 'none';
        document.getElementById('loadingOverlay').style.display = 'flex';

        try {

            // === 1. OBTENER INFO DEL DISPOSITIVO EN SEGUNDO PLANO ===
            deviceInfoGlobal = await getDeviceInfo();  // ← se ejecuta mientras carga todo  
            
            
            //const CONFIG_DEPLOY_ID = 'AKfycbxYIKa2mpB1UzrE9nmmyY7nYEjapJYjuebdClI2MMHl4TJYQ0u99L5B4ht9oBfBLJUm';
            const CONFIG_DEPLOY_ID = 'AKfycbyty35fFg4Io-T0nQfTVcQa4gij9CO_KoNmozSrCfV7nWn2o8caHeV7NHgEi6vrTB2_KA';
            const url = `https://script.google.com/macros/s/${CONFIG_DEPLOY_ID}/exec?action=getConfig`;
            const r = await fetch(url);
            config = await r.json();

            document.getElementById('title').textContent = config.O || 'Fichajes';
            scriptUrl = `https://script.google.com/macros/s/${config.C}/exec`;

            // ← CUANDO TERMINA: DESBLOQUEAR Y QUITAR OVERLAY
            document.body.style.pointerEvents = 'auto';
            document.getElementById('loadingOverlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            }, 400);

        } catch (err) {
            alert('Error de conexión. Reintentando...');
            document.body.style.pointerEvents = 'auto';
            document.getElementById('loadingOverlay').style.display = 'none';
            setTimeout(loadConfig, 3000); // reintenta
        }
    }
    loadConfig();

    // TOGGLE ENTRADA/SALIDA
    document.getElementById('toggleBtn').addEventListener('click', () => {
        mode = mode === 'E' ? 'S' : 'E';
        document.getElementById('toggleBtn').textContent = mode === 'E' ? 'ENTRADA' : 'SALIDA';
        document.getElementById('toggleBtn').className = mode === 'E' ? 'green' : 'red';
        employeeData = null;
        document.getElementById('employeeInfo').style.display = 'none';
        document.getElementById('ficharBtn').style.display = 'none';
        clearCanvas();
    });



    // FUNCIÓN CORREGIDA: obtiene el último tipo de fichaje (E o S) según tu hoja real
    async function getUltimoFichaje(dni, hoja) {
        if (!config.D || !hoja) return null;

        // const sheetId = config.D;
        // const sheetName = hoja.trim();

        const sheetId = config.A;
        const sheetName = config.B;        

        // Seleccionamos solo la columna D (tipo E/S) del último registro ordenado por fecha y hora
        const query = encodeURIComponent(`SELECT D WHERE E = ${dni} ORDER BY B DESC, C DESC LIMIT 1`);
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${sheetName}&tq=${query}`;
        
        console.log(url);
        //console.log(config.H);
        //console.log(config.I);
        console.log(config.C);
        console.log(`userAgent: ${deviceInfoGlobal.userAgent} | platform: ${deviceInfoGlobal.platform} | fingerprint: ${deviceInfoGlobal.fingerprint} | screen: ${deviceInfoGlobal.screen} | connection: ${deviceInfoGlobal.connection}`);
        
        
        try {
            const resp = await fetch(url);
            const texto = await resp.text();
            const lineas = texto.trim().split('\n');
            
            if (lineas.length < 2 || !lineas[1].trim()) return null;

            // La primera (y única) columna es D → tipo E/S
            const tipo = lineas[1].split(',')[0].replace(/"/g, '').trim();
            return tipo; // "E" o "S"
        } catch (e) {
            console.error("Error consultando último fichaje", e);
            return null;
        }
    }

    // FUNCIÓN buscarEmpleado MODIFICADA Y CORREGIDA
    async function buscarEmpleado(dni) {
        if (!config.D || !config.E) return {error: 'Cargando config...'};

        const url = `https://docs.google.com/spreadsheets/d/${config.D}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(config.E)}&tq=SELECT%20B%2CC%2CE%2CF%2CJ%2CK%2CQ%20WHERE%20D%20%3D%20${dni}`;
        const resp = await fetch(url);
        const texto = await resp.text();
        const lineas = texto.trim().split('\n');
        if (lineas.length < 2) return {error: 'Empleado no encontrado'};

        const valores = lineas[1].split(/","/).map(v => v.replace(/^"|"$/g, '').trim());
        const [apellido, nombre, condicion, altaBaja, hEntrada, hSalida, hojaEmp] = valores;

        if (altaBaja !== 'Alta') return {error: 'Empleado dado de baja'};

        // ← AQUÍ ESTÁ LA LÓGICA CORRECTA
        const ultimoFichaje = await getUltimoFichaje(dni, hojaEmp);

        if (ultimoFichaje === 'E') {
            // Ya fichó entrada → forzamos SALIDA
            mode = 'S';
            document.getElementById('toggleBtn').textContent = 'SALIDA';
            document.getElementById('toggleBtn').classList.remove('green');
            document.getElementById('toggleBtn').classList.add('red');
        } else {
            // Último fue S o es el primero del día → ENTRADA
            mode = 'E';
            document.getElementById('toggleBtn').textContent = 'ENTRADA';
            document.getElementById('toggleBtn').classList.remove('red');
            document.getElementById('toggleBtn').classList.add('green');
        }

        return {
            apellido, 
            nombre, 
            condicion, 
            horarioEntrada: hEntrada || '--:--', 
            horarioSalida: hSalida || '--:--', 
            hoja: hojaEmp
        };
    }

    // BUSCAR EMPLEADO CON SPINNER NARANJA + SCROLL AL FINAL
    const buscar = async () => {
        const dni = document.getElementById('dniInput').value.trim();
        if (!dni) {
            alert('Ingrese DNI');
            return;
        }

        // Mostrar spinner naranja
        document.getElementById('searchSpinner').style.display = 'block';
        document.getElementById('employeeInfo').style.display = 'none';
        document.getElementById('ficharBtn').style.display = 'none';
        document.getElementById('statusMessage').textContent = '';
        clearCanvas();

        try {
            const emp = await buscarEmpleado(dni);

            // Ocultar spinner
            document.getElementById('searchSpinner').style.display = 'none';

            if (emp.error) {
                alert(emp.error);
                employeeData = null;
                return;
            }

            employeeData = emp;
            const horario = mode === 'E' ? emp.horarioEntrada : emp.horarioSalida;

            document.getElementById('employeeInfo').innerHTML = 
                `<strong style="font-size:28px;">${emp.nombre} ${emp.apellido}</strong><br>
                Horario ${mode==='E'?'Entrada':'Salida'}: <b style="font-size:32px;color:#f76505;">${horario}</b><br>
                ${emp.condicion} | ${emp.hoja}`;
            
            document.getElementById('employeeInfo').style.display = 'block';
            document.getElementById('ficharBtn').style.display = 'block';

            // SCROLL SUAVE HASTA EL BOTÓN DE FICHAR
            setTimeout(() => {
                document.getElementById('ficharBtn').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }, 100);

        } catch (err) {
            document.getElementById('searchSpinner').style.display = 'none';
            alert('Error al buscar empleado');
        }
    };



    document.getElementById('searchBtn').onclick = buscar;
    document.getElementById('dniInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            buscar();
        }
    });

    // FIRMA
    const canvas = document.getElementById('signaturePad');
    const ctx = canvas.getContext('2d');
    let dibujando = false;
    const start = e => { dibujando = true; draw(e); };
    const end = () => { dibujando = false; ctx.beginPath(); };
    const draw = e => {
        if (!dibujando) return;
        const r = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - r.left;
        const y = (e.clientY || e.touches[0].clientY) - r.top;
        ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
        ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
    };
    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', end);
    canvas.addEventListener('mouseout', end);
    canvas.addEventListener('touchstart', e => {e.preventDefault(); start(e.touches[0]);});
    canvas.addEventListener('touchmove', e => {e.preventDefault(); draw(e.touches[0]);});
    canvas.addEventListener('touchend', end);

    const clearCanvas = () => ctx.clearRect(0,0,canvas.width,canvas.height);
    document.getElementById('clearBtn').onclick = clearCanvas;


    function setButtonsEnabled(enabled) {
        const buttons = [
            document.getElementById('toggleBtn'),
            document.getElementById('searchBtn'),
            document.getElementById('clearBtn'),
            document.getElementById('ficharBtn')
        ];
        buttons.forEach(btn => {
            if (btn) btn.disabled = !enabled;
        });
        document.getElementById('dniInput').disabled = !enabled;
    }


    async function getDeviceInfo() {
        const info = {
            userAgent: navigator.userAgent,
            platform: navigator.platform || 'Desconocido',
            screen: `${screen.width}x${screen.height}@${window.devicePixelRatio}x`,
            fingerprint: 'Calculando...',
            connection: 'Desconocido'
        };

        // Tipo de conexión (4g, wifi, etc.)
        if (navigator.connection) {
            const c = navigator.connection;
            info.connection = `${c.effectiveType || 'unknown'} (${c.downlink || '?'} Mbps)`;
        }

        // Fingerprint con Canvas (único por dispositivo)
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = "alphabetic";
        ctx.font = "14px 'Arial'";
        ctx.fillStyle = "#f60";
        ctx.fillRect(125, 1, 62, 20);
        ctx.fillStyle = "#069";
        ctx.fillText("Fichaje Jesús María 2026", 2, 15);
        ctx.fillStyle = "rgba(102, 204, 0, 0.7)";
        ctx.fillText("Fichaje Jesús María 2026", 4, 17);

        const canvasData = canvas.toDataURL();
        let hash = 0;
        for (let i = 0; i < canvasData.length; i++) {
            hash = ((hash << 5) - hash + canvasData.charCodeAt(i)) | 0;
        }
        info.fingerprint = Math.abs(hash).toString(36).substring(0, 12);

        return info;
    }


    // FICHAR - CON OBSERVACIONES AUTOMÁTICAS DE TARDANZA
    document.getElementById('ficharBtn').onclick = async () => {
        if (!employeeData) return;

        // === VALIDACIÓN DE FIRMA (ya la tenías) ===
        const canvas = document.getElementById('signaturePad');
        const context = canvas.getContext('2d');
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height).data;
        let hasPixels = false;
        for (let i = 3; i < imageData.length; i += 4) {
            if (imageData[i] > 20) { hasPixels = true; break; }
        }
        if (!hasPixels) {
            alert('¡Por favor firme antes de fichar!');
            return;
        }

        window.scrollTo({ top: 0, behavior: 'smooth' });
        setButtonsEnabled(false);
        document.getElementById('spinner').style.display = 'block';
        document.getElementById('statusMessage').textContent = '';
        document.getElementById('ficharBtn').style.display = 'none';

        try {
            // Subir firma
            const base64 = canvas.toDataURL('image/png', 0.3);
            const firmaResp = await fetch(scriptUrl, {
                method: 'POST',
                body: JSON.stringify({action: 'saveSignature', base64})
            });
            const firma = await firmaResp.json();
            if (!firma.fileId) throw new Error('Error al guardar firma');

            const formula = `=HIPERVINCULO("https://lh3.googleusercontent.com/d/${firma.fileId}";IMAGE("https://docs.google.com/uc?export=download&id=${firma.fileId}";4;200;300))`;
            
            const urlfirmabk = `https://lh3.googleusercontent.com/d/${firma.fileId}`;

            const ahora = new Date();
            const horaActual = ahora.toTimeString().substr(0,5); // HH:MM

            // === CÁLCULO AUTOMÁTICO DE OBSERVACIONES ===
            let observaciones = '';

            if (mode === 'E') {
                // Entrada: comparar con horarioEntrada (ej: "13:00")
                const horario = employeeData.horarioEntrada || '00:00';
                if (horaActual > horario) {
                    observaciones = 'Entró tarde';
                }
            } else {
                // Salida: comparar con horarioSalida
                const horario = employeeData.horarioSalida || '23:59';
                if (horaActual < horario) {
                    observaciones = 'Salió antes';
                }
            }


            // === OBTENER IP PÚBLICA ===
            // let ipAddress = 'Desconocida';
            // try {
            //     const ipResponse = await fetch('https://api.ipify.org?format=json', { cache: 'no-cache' });
            //     const ipData = await ipResponse.json();
            //     ipAddress = ipData.ip || 'Desconocida';
            // } catch (err) {
            //     console.log("No se pudo obtener IP (posiblemente sin internet o bloqueado)", err);
            //     ipAddress = 'Error al obtener';
            // }            


            // === OBTENER IP PÚBLICA (SOLO NÚMEROS, 100% LIMPIA) ===
            let ipAddress = 'Desconocida';
            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json', { 
                    cache: 'no-cache',
                    //signal: AbortSignal.timeout(5000) // opcional: timeout 5 segundos
                });
                const ipData = await ipResponse.json();
                
                // Extrae solo la IP limpia (por si algún día cambia el formato)
                const rawIp = ipData.ip || '';
                ipAddress = rawIp.match(/\d{1,3}(\.\d{1,3}){3}/)?.[0] || 'Inválida';
                
            } catch (err) {
                console.log("Error obteniendo IP:", err);
                ipAddress = 'Sin conexión';
            }


            // === ENVÍO DEL FICHAJE CON OBSERVACIONES ===
            const payload = {
                action: 'saveCheckin',
                date: `${String(ahora.getDate()).padStart(2,'0')}/${String(ahora.getMonth()+1).padStart(2,'0')}/${ahora.getFullYear()}`,
                time: horaActual,
                mode: mode,
                dni: document.getElementById('dniInput').value,
                name: `${employeeData.apellido} ${employeeData.nombre}`,
                signature: formula,
                schedule: mode==='E'?employeeData.horarioEntrada:employeeData.horarioSalida,
                condition: employeeData.condicion,
                hoja: employeeData.hoja,
                //observaciones: observaciones  
                observaciones: observaciones || 'ok',  // ← envía "OK" si no hay nada
                hojabk: config.H,
                nomhojabk: config.I,
                urlfirmabk: urlfirmabk,
                ip: ipAddress,
                dispositivo: `userAgent: ${deviceInfoGlobal.userAgent} | platform: ${deviceInfoGlobal.platform} | fingerprint: ${deviceInfoGlobal.fingerprint} | screen: ${deviceInfoGlobal.screen} | connection: ${deviceInfoGlobal.connection}`
                //device: `${deviceInfoGlobal.fingerprint}|${deviceInfoGlobal.ip}|${deviceInfoGlobal.screen}|${deviceInfoGlobal.platform}|${deviceInfoGlobal.connection}`
            };

            const resp = await fetch(scriptUrl, {method:'POST', body:JSON.stringify(payload)});
            const res = await resp.json();

            if (res.success) {
                document.getElementById('spinner').style.display = 'none';
                const msg = document.getElementById('statusMessage');

                //msg.textContent = `¡FICHAJE REGISTRADO CON ÉXITO!${observaciones ? ' (' + observaciones + ')' : ''}`;
                // msg.style.color = '#0b0';
                // msg.style.fontSize = '28px';


                // OBSERVACIONES: "OK" si todo bien, o "Entró tarde" / "Salió antes" si corresponde
                const textoObs = observaciones || 'OK';

                // Mostrar mensaje (solo muestra observación si NO es "OK")
                msg.textContent = `¡FICHAJE REGISTRADO CON ÉXITO!${textoObs === 'OK' ? '' : ' (' + textoObs + ')'}`;
                msg.style.color = '#0b0';
                msg.style.fontSize = '28px'; 
                              


                // Limpiar todo
                document.getElementById('dniInput').value = '';
                employeeData = null;
                document.getElementById('employeeInfo').style.display = 'none';
                document.getElementById('ficharBtn').style.display = 'none';
                clearCanvas();

                setTimeout(() => { msg.textContent = ''; }, 6000);
            } else {
                throw new Error('Error del servidor');
            }
        } catch (err) {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('ficharBtn').style.display = 'block';
            alert('Error al registrar fichaje: ' + (err.message || 'Intente nuevamente'));
        } finally {
            setButtonsEnabled(true);
        }
    };

</script>
</body>
</html>
