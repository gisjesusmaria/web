<!-- 22012026_1222 -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa para EPH - Sectores</title>

  <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/gisjesusmaria/web/refs/heads/main/favicon.ico">

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --azul:#0b5ed7;
      --azul2:#1976d2;
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#1a1a1a;
      --shadow:0 2px 10px rgba(0,0,0,.10);
      --radius:14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin: 14px;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .logo{
      display:block;
      margin: 0 auto 10px;
      max-width: 140px;
      height:auto;
    }

    h1{
      text-align:center;
      margin: 0 0 12px 0;
      font-size: 26px;
      font-weight: 800;
      color: #111;
    }

    .wrap{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.06);
    }

    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, #ffffff 0%, #fafbff 100%);
    }
    .toolbar-left{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(11,94,215,.25);
      background: rgba(11,94,215,.06);
      font-size: 13px;
      font-weight: 700;
      color: #0b3f9b;
      user-select:none;
    }
    .btn{
      appearance:none;
      border: 0;
      background: var(--azul);
      color: white;
      font-weight: 800;
      padding: 9px 12px;
      border-radius: 10px;
      cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.12);
    }
    .btn:hover{ filter: brightness(.95); }
    .btn:active{ transform: translateY(1px); }

    .chk{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.10);
      background: #fff;
      font-size: 13px;
      font-weight: 700;
      user-select:none;
    }
    .chk input{ transform: scale(1.05); }

    #map{
      height: calc(100vh - 200px);
      min-height: 520px;
      width: 100%;
    }

    .sector-label{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.20);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 900;
      color: #0b3f9b;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      white-space: nowrap;
    }

    .status{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 13px;
      font-weight: 700;
      color: #334155;
    }
    .spinner{
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 3px solid rgba(25,118,210,.25);
      border-top-color: rgba(25,118,210,1);
      animation: spin .9s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    .err{
      color:#b91c1c;
      background:#fee2e2;
      border:1px solid #fecaca;
      padding: 8px 10px;
      border-radius: 10px;
      font-weight: 800;
      display:none;
    }

    .leaflet-control-layers{
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,.10);
    }
    .leaflet-control-zoom{
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,.10);
      overflow:hidden;
    }

    #sectorSearch,
    #sectorSearch::placeholder,
    #btnSectorGo{
    font-family: Arial, Helvetica, sans-serif;
    }

    #sectorSearch,
    #btnSectorGo{
    font-family: "Segoe UI", system-ui, Arial, sans-serif !important;
    }

    #sectorSearch::placeholder{
    font-family: "Segoe UI", system-ui, Arial, sans-serif !important;
    font-weight: 600;
    }

    #sectorSearch::-webkit-input-placeholder{
    font-family: "Segoe UI", system-ui, Arial, sans-serif !important;
    font-weight: 600;
    }
    #sectorSearch::-moz-placeholder{
    font-family: "Segoe UI", system-ui, Arial, sans-serif !important;
    font-weight: 600;
    }


    .sector-search{
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 6px;
    flex-wrap: wrap;
    }

    #sectorSearch{
    padding: 7px 12px;
    border-radius: 999px;
    border: 1px solid rgba(11,94,215,.25);
    font-weight: 800;
    font-size: 13px;
    min-width: 220px;
    max-width: 100%;
    }

    #btnSectorGo{
    padding: 7px 14px;
    border-radius: 999px;
    }

    @media (max-width: 600px){
    .sector-search{
        width: 100%;
    }
    #sectorSearch{
        width: 100%;
        min-width: 0;
    }
    #btnSectorGo{
        width: 100%;
    }
    }


    .user-dot{
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #0066ff;
    border: 3px solid #ffffff;
    box-shadow: 0 0 0 3px rgba(0,102,255,.35), 0 8px 18px rgba(0,0,0,.25);
    }

    .user-dot.pulse{
    position: relative;
    }
    .user-dot.pulse::after{
    content:"";
    position:absolute;
    left:50%;
    top:50%;
    width: 46px;
    height: 46px;
    transform: translate(-50%,-50%);
    border-radius: 50%;
    border: 2px solid rgba(0,102,255,.35);
    animation: userPulse 1.6s ease-out infinite;
    }
    @keyframes userPulse{
    0%   { transform: translate(-50%,-50%) scale(.25); opacity: .8; }
    100% { transform: translate(-50%,-50%) scale(1.05); opacity: 0; }
    }



  </style>
</head>

<body>
  <img
    src="https://raw.githubusercontent.com/gisjesusmaria/web/refs/heads/main/Logos/Logo01ConFondoWide.png"
    alt="Logo Municipalidad"
    class="logo"
  />

  <h1>Mapa para EPH | Sectores</h1>

  <div class="wrap">
    <div class="toolbar">
      <div class="toolbar-left">

        <input type="text" 
            id="sectorSearch" 
            list="sectorOptions"
            placeholder="Buscar sector…" 
            style="padding:7px 10px;border-radius:999px;border:1px solid rgba(11,94,215,.25);font-weight:800;font-size:13px;outline:none;min-width:220px;"
            autocomplete="off"
            maxlength="6"
            pattern="[0-9]*"  
            inputmode="numeric"
            oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,8)">


        <datalist id="sectorOptions"></datalist>

        <button class="btn" id="btnSectorGo" style="padding:7px 10px;border-radius:999px;">
            Buscar
        </button>

        <label class="chk" title="Muestra/oculta las etiquetas con el nombre del sector">
          <input id="toggleLabels" type="checkbox" checked />
          Etiquetas (sector)
        </label>

        <button class="btn" id="btnZoom">Zoom a todo</button>

        <div class="status" id="status">
        <span class="spinner" id="spinner"></span>
        <span id="statusText">Cargando GeoJSON…</span>

        <span class="pill" id="lblLat">Lat: —</span>
        <span class="pill" id="lblLng">Lng: —</span>
        <span class="pill" id="lblZoom">Zoom: —</span>

        </div>


      </div>

      <div class="err" id="errBox">No se pudo cargar el GeoJSON.</div>
    </div>

    <div id="map"></div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const GEOJSON_URL = "https://raw.githubusercontent.com/gisjesusmaria/web/refs/heads/main/eph/mzweb.geojson";

    const map = L.map("map", {
      center: [-31.0, -64.1], 
      zoom: 13,
      zoomControl: true
    });

    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 22,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const googleSat = L.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", {
      maxZoom: 22,
      attribution: "Imagery © Google"
    });

    const baseLayers = {
      "OSM": osm,
      "Google Satellite": googleSat
    };

    L.control.layers(baseLayers, null, { position: "topright", collapsed: true }).addTo(map);

    const statusEl = document.getElementById("status");
    const statusText = document.getElementById("statusText");
    const spinner = document.getElementById("spinner");
    const errBox = document.getElementById("errBox");
    const toggleLabels = document.getElementById("toggleLabels");
    const btnZoom = document.getElementById("btnZoom");

    let geoLayer = null;
    let labelLayer = L.layerGroup().addTo(map);
    let lastBounds = null;


    let sectorIndex = new Map();

    const sectorSearch  = document.getElementById("sectorSearch");
    const sectorOptions = document.getElementById("sectorOptions");
    const btnSectorGo   = document.getElementById("btnSectorGo");


    function normSector(v){
    return String(v ?? "")
        .trim()
        .toLowerCase();
    }

    function poblarDatalistSectores(){
    sectorOptions.innerHTML = "";
    const items = Array.from(sectorIndex.values())
        .map(x => x.sectorOriginal)
        .filter(Boolean)
        .sort((a,b)=> String(a).localeCompare(String(b), "es", { sensitivity:"base" }));

    for (const s of items){
        const opt = document.createElement("option");
        opt.value = s;
        sectorOptions.appendChild(opt);
    }
    }

    function zoomASector(valor){
    const key = normSector(valor);
    if (!key) return;

    const hit = sectorIndex.get(key);
    if (!hit) {
        const foundKey = Array.from(sectorIndex.keys()).find(k => k.includes(key));
        if (!foundKey) {
        alert("No se encontró el sector: " + valor);
        return;
        }
        return zoomASector(foundKey);
    }

    const layer = hit.layer;
    const b = layer.getBounds?.();
    if (b && b.isValid()){
        map.fitBounds(b.pad(0.10));
    }

    try { layer.openPopup(); } catch(e){}

    const orig = { weight: 2, fillOpacity: 0.18 };
    layer.setStyle?.({ weight: 5, fillOpacity: 0.35 });
    setTimeout(() => layer.setStyle?.(orig), 600);
    }


    let userMarker = null;
    let userAccuracyCircle = null;
    let geoWatchId = null;
    let userHasCenteredOnce = false;

    const userIcon = L.divIcon({
    className: "",
    html: `<div class="user-dot pulse"></div>`,
    iconSize: [18, 18],
    iconAnchor: [9, 9]
    });

    function startUserLocation() {
    if (!("geolocation" in navigator)) {
        console.warn("Geolocalización no soportada en este navegador.");
        return;
    }

    if (geoWatchId !== null) return;

    geoWatchId = navigator.geolocation.watchPosition(
        (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const acc = Math.max(10, pos.coords.accuracy || 0);

        const latlng = [lat, lng];

        if (!userMarker) {
            userMarker = L.marker(latlng, { icon: userIcon, zIndexOffset: 1000 }).addTo(map);
        } else {
            userMarker.setLatLng(latlng);
        }

        if (!userAccuracyCircle) {
            userAccuracyCircle = L.circle(latlng, {
            radius: acc,
            weight: 2,
            opacity: 0.8,
            fillOpacity: 0.15
            }).addTo(map);
        } else {
            userAccuracyCircle.setLatLng(latlng);
            userAccuracyCircle.setRadius(acc);
        }

        if (!userHasCenteredOnce) {
            userHasCenteredOnce = true;
            map.setView(latlng, Math.max(map.getZoom(), 17));
        }
        },
        (err) => {
        console.warn("Error geolocalización:", err);
        },
        {
        enableHighAccuracy: true,
        maximumAge: 2000,   
        timeout: 15000
        }
    );
    }

    function stopUserLocation() {
    if (geoWatchId !== null) {
        navigator.geolocation.clearWatch(geoWatchId);
        geoWatchId = null;
    }
    }

    startUserLocation();

    window.addEventListener("beforeunload", stopUserLocation);




    function setStatus(text, loading=true){
      statusText.textContent = text;
      spinner.style.display = loading ? "inline-block" : "none";
    }
    function showError(msg){
      errBox.textContent = msg || "No se pudo cargar el GeoJSON.";
      errBox.style.display = "block";
      setStatus("Error.", false);
    }
    function hideError(){
      errBox.style.display = "none";
    }

    function styleFeature(){
      return {
        color: "#ea580c",
        weight: 2,
        opacity: 0.95,
        fillColor: "#fb923c",
        fillOpacity: 0.30
      };
    }

    function centroidOfCoords(coords){
      let sumX = 0, sumY = 0, n = 0;
      for (const p of coords){
        if (!p || p.length < 2) continue;
        sumX += p[0];
        sumY += p[1];
        n++;
      }
      if (!n) return null;
      return [sumY / n, sumX / n];
    }

    function getFeatureCentroid(feature){
      const g = feature && feature.geometry;
      if (!g) return null;

      if (g.type === "Polygon"){
        const ring = (g.coordinates && g.coordinates[0]) || [];
        return centroidOfCoords(ring);
      }

      if (g.type === "MultiPolygon"){
        const firstPoly = (g.coordinates && g.coordinates[0]) || [];
        const ring = (firstPoly && firstPoly[0]) || [];
        return centroidOfCoords(ring);
      }

      return null;
    }

    function clearLabels(){
      labelLayer.clearLayers();
    }

    function addLabel(feature){
      const props = feature.properties || {};
      const sector = props.sector ?? props.SECTOR ?? props.Sector ?? props["SECTOR"] ?? "";
      if (!sector) return;

      const c = getFeatureCentroid(feature);
      if (!c) return;

      const marker = L.marker(c, {
        interactive: false,
        icon: L.divIcon({
          className: "",
          html: `<div class="sector-label">${String(sector)}</div>`
        })
      });

      labelLayer.addLayer(marker);
    }

    function bindFeatureInteractions(feature, layer){
      const props = feature.properties || {};
      const sector = props.sector ?? props.SECTOR ?? props.Sector ?? props["SECTOR"] ?? "—";

      layer.on("mouseover", () => {
        layer.setStyle({ weight: 3, fillOpacity: 0.28 });
      });
      layer.on("mouseout", () => {
        layer.setStyle({ weight: 2, fillOpacity: 0.18 });
      });

      const rows = Object.entries(props)
        .slice(0, 30)
        .map(([k,v]) => `<tr><td style="padding:2px 6px;font-weight:800;color:#0b3f9b;">${k}</td><td style="padding:2px 6px;">${String(v)}</td></tr>`)
        .join("");

      layer.bindPopup(`
        <div style="font-family:Arial,Helvetica,sans-serif;min-width:240px;">
          <div style="font-size:14px;font-weight:900;margin-bottom:6px;color:#111;">Sector: ${String(sector)}</div>
          <table style="width:100%;border-collapse:collapse;font-size:12px;">
            ${rows || "<tr><td>No hay propiedades.</td></tr>"}
          </table>
        </div>
      `);
    }

    async function loadGeoJSON(){
      hideError();
      setStatus("Cargando GeoJSON…", true);

      try{
        const res = await fetch(GEOJSON_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (geoLayer) map.removeLayer(geoLayer);
        clearLabels();

        sectorIndex = new Map();


        geoLayer = L.geoJSON(data, {
          style: styleFeature,

            onEachFeature: (feature, layer) => {
            bindFeatureInteractions(feature, layer);
            addLabel(feature);

            const props = feature.properties || {};
            const sector = props.sector ?? props.SECTOR ?? props.Sector ?? props["SECTOR"] ?? "";
            const k = normSector(sector);
            if (k) sectorIndex.set(k, { sectorOriginal: String(sector), layer });
            }


        }).addTo(map);

        lastBounds = geoLayer.getBounds();
        if (lastBounds && lastBounds.isValid()){
          map.fitBounds(lastBounds.pad(0.05));
        }

        if (!toggleLabels.checked){
          map.removeLayer(labelLayer);
        } else if (!map.hasLayer(labelLayer)){
          labelLayer.addTo(map);
        }

        setStatus("GeoJSON cargado.", false);

        actualizarVisibilidadEtiquetasSectores();

        poblarDatalistSectores();


      } catch(err){
        console.error(err);
        showError("No se pudo cargar el GeoJSON. Revisá la URL o la conexión.");
      }
    }

    toggleLabels.addEventListener("change", () => {
      if (toggleLabels.checked){
        if (!map.hasLayer(labelLayer)) labelLayer.addTo(map);
      } else {
        if (map.hasLayer(labelLayer)) map.removeLayer(labelLayer);
      }
    });

    btnZoom.addEventListener("click", () => {
      if (lastBounds && lastBounds.isValid()){
        map.fitBounds(lastBounds.pad(0.05));
      }
    });


    const lblLat  = document.getElementById("lblLat");
    const lblLng  = document.getElementById("lblLng");
    const lblZoom = document.getElementById("lblZoom");

    function actualizarIndicadores() {
    const c = map.getCenter();
    lblLat.textContent  = "Lat: "  + c.lat.toFixed(5);
    lblLng.textContent  = "Lng: "  + c.lng.toFixed(5);
    lblZoom.textContent = "Zoom: " + map.getZoom();
    }

    map.on("moveend zoomend", actualizarIndicadores);

    actualizarIndicadores();


    function actualizarVisibilidadEtiquetasSectores() {
      const visiblePorZoom = map.getZoom() >= 17;
      const visiblePorToggle = toggleLabels.checked;

      const debeVerse = visiblePorZoom && visiblePorToggle;

      if (debeVerse) {
        if (!map.hasLayer(labelLayer)) labelLayer.addTo(map);
      } else {
        if (map.hasLayer(labelLayer)) map.removeLayer(labelLayer);
      }
    }

    map.on("zoomend", actualizarVisibilidadEtiquetasSectores);

    toggleLabels.addEventListener("change", actualizarVisibilidadEtiquetasSectores);



    loadGeoJSON();


    btnSectorGo.addEventListener("click", () => {
    zoomASector(sectorSearch.value);
    });

    sectorSearch.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
        e.preventDefault();
        zoomASector(sectorSearch.value);
    }
    });

  </script>
</body>
</html>


