<!DOCTYPE html>
<html lang="es">
<head>
    <title>Fuente de Datos IP/Hora</title>
</head>
<body>
    <!-- Este contenido se reemplazará por el script. -->
    Obteniendo datos...

    <script>
        // Función para formatear la fecha en GMT-3 (Argentina)
        function getFormattedTime() {
            const now = new Date();
            // Desplazamiento para GMT-3 en minutos
            const gmtMinus3Offset = -3 * 60;
            // Creamos una fecha que ya está ajustada a GMT-3
            const localTime = new Date(now.getTime() + (gmtMinus3Offset * 60 * 1000));

            const day = String(localTime.getUTCDate()).padStart(2, '0');
            const month = String(localTime.getUTCMonth() + 1).padStart(2, '0');
            const year = localTime.getUTCFullYear();
            const hours = String(localTime.getUTCHours()).padStart(2, '0');
            const minutes = String(localTime.getUTCMinutes()).padStart(2, '0');
            const seconds = String(localTime.getUTCSeconds()).padStart(2, '0');

            return `${day}-${month}-${year}_${hours}:${minutes}:${seconds}`;
        }

        // Función principal para obtener la IP y escribir los datos.
        async function fetchDataAndWrite() {
            try {
                // 1. Obtener la IP pública
                const response = await fetch('https://api.ipify.org?format=text');
                if (!response.ok) {
                    throw new Error('No se pudo obtener la IP.');
                }
                const ip = await response.text();
                
                // 2. Obtener la hora formateada
                const time = getFormattedTime();
                
                // 3. Combinar los datos en formato CSV
                const csvContent = `${ip},${time}`;
                
                // 4. Reemplazar TODO el contenido de la página con el texto del CSV.
                // App Inventor recibirá SOLAMENTE esta cadena de texto.
                document.open();
                document.write(csvContent);
                document.close();

            } catch (error) {
                console.error('Error:', error);
                // Si algo falla, la página devolverá la palabra "ERROR".
                document.open();
                document.write('ERROR: No se pudieron obtener los datos.');
                document.close();
            }
        }

        // Ejecutar la función inmediatamente.
        fetchDataAndWrite();
    </script>
</body>
</html>
