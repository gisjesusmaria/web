<!-- 21112025_1208 -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Aires de Campo - Adjudicación Interna</title>
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/gisjesusmaria/web/refs/heads/main/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body,html,#map{margin:0;padding:0;height:100%;width:100%;font-family:Arial,sans-serif}
        .lote-label{
            background:transparent!important;border:none!important;box-shadow:none!important;
            font-weight:bold!important;color:white!important;text-shadow:2px 2px 5px black!important;
            font-size:18px!important;pointer-events:none;text-align:center;
        }
        .custom-popup .leaflet-popup-content{margin:16px;font-size:15px;line-height:1.6}
        .custom-popup select{width:100%;padding:10px;margin:12px 0;font-size:15px}
        .custom-popup button{width:100%;padding:14px;background:#4caf50;color:white;border:none;border-radius:8px;
            cursor:pointer;font-weight:bold;font-size:16px;margin-top:15px}
        .custom-popup button:disabled{background:#999;cursor:not-allowed}
        .coords-control{background:rgba(255,255,255,0.95);padding:10px 14px;border-radius:6px;
            font-size:16px;box-shadow:0 0 12px rgba(0,0,0,0.3);pointer-events:none}
        #toast{position:fixed;bottom:20px;right:20px;background:#dc2626;color:white;padding:12px 20px;
            border-radius:8px;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:2000;
            opacity:0;transform:translateY(20px);transition:all 0.3s ease;max-width:400px;font-size:1rem}
        #toast.show{opacity:1;transform:translateY(0)}
    </style>
</head>
<body>
<div id="map"></div>
<div id="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const GITHUB_TOKEN = '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';
const REPO = 'gisjesusmaria/web';
const PATH = 'Habitat/LotesParaAdjudicar.geojson';
const BRANCH = 'main';


let map = L.map('map').setView([-30.981203, -64.126409], 17);

const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    maxZoom: 22,
    attribution: 'Google Satellite'
});

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 22,
    attribution: '&copy; OpenStreetMap contributors'
});


googleSat.addTo(map);


L.control.layers({
    "Google Satellite": googleSat,
    "OpenStreetMap": osm
}, null, { 
    position: 'topright',
    collapsed: true
}).addTo(map);

let lotesLayer = L.geoJSON(null, {
    style: feature => {
        const e = (feature.properties?.estado || "Disponible").trim();
        if (e === "Adjudicado") return {fillColor:"#ff5722", color:"#e64a19", weight:3, fillOpacity:0.95};
        if (e === "No disponible") return {fillColor:"#9c27b0", color:"#7b1fa2", weight:1.5, fillOpacity:0.8};
        return {fillColor:"#4caf50", color:"#388e3c", weight:1.5, fillOpacity:0.7};
    },



    onEachFeature: (feature, layer) => {
        layer.on('click', () => abrirPopup(layer, feature));

        const props = feature.properties || {};
        const estado = (props.estado || "Disponible").trim();
        const manzana = props.manzana || '';
        const lote = props.lote || '';

        if (estado === "Disponible" && manzana && lote) {
            const etiqueta = `${manzana}-${lote}`;

            layer.bindTooltip(etiqueta, {
                permanent: true,
                direction: 'center',
                className: 'lote-label',
                offset: [0, 0]
            });

            const controlarVisibilidadEtiqueta = () => {
                if (map.getZoom() >= 19) {
                    layer.openTooltip();   
                } else {
                    layer.closeTooltip();  
                }
            };


            controlarVisibilidadEtiqueta();
            map.on('zoomend', controlarVisibilidadEtiqueta);

            map.on('layeradd', function(e) {
                if (e.layer === layer) {
                    controlarVisibilidadEtiqueta();
                }
            });
        }
    }

}).addTo(map);


function showToast(msg, color = '#dc2626') {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.style.background = color;
    toast.classList.remove('show');
    void toast.offsetWidth;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 4000);
}


const coordsControl = L.control({ position: 'bottomleft' });
coordsControl.onAdd = function() {
    const div = L.DomUtil.create('div', 'coords-control');
    div.innerHTML = 'Lat: <span id="lat">-</span> | Lng: <span id="lng">-</span> | Zoom: <span id="zoom">-</span>';
    return div;
};
coordsControl.addTo(map);

function updateCoords() {
    const c = map.getCenter();
    document.getElementById('lat').textContent = c.lat.toFixed(6);
    document.getElementById('lng').textContent = c.lng.toFixed(6);
    document.getElementById('zoom').textContent = map.getZoom();
}
map.on('moveend zoomend', updateCoords);
updateCoords();


async function recargarMapa() {
    try {
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${PATH}?ref=${BRANCH}&t=${Date.now()}`, {
            headers: { Authorization: `token ${GITHUB_TOKEN}` },
            cache: 'no-store'
        });
        if (!res.ok) throw new Error("No se pudo cargar");
        const info = await res.json();
        const datos = JSON.parse(atob(info.content));
        lotesLayer.clearLayers().addData(datos);
    } catch (e) {
        console.warn("Recarga falló:", e);
    }
}


async function guardarLote(feature, btn) {
    const id = feature.properties?.id || feature.id;
    if (!id) return showToast("Sin ID!", "#dc2626");

    btn.disabled = true;
    btn.textContent = "Guardando...";

    try {
        const meta = await fetch(`https://api.github.com/repos/${REPO}/contents/${PATH}?ref=${BRANCH}`, {
            headers: { Authorization: `token ${GITHUB_TOKEN}` },
            cache: 'no-store'
        });
        if (!meta.ok) throw new Error("No meta");
        const info = await meta.json();
        const datos = JSON.parse(atob(info.content));

        const f = datos.features.find(x => (x.properties?.id || x.id) == id);
        if (!f) throw new Error("Lote no encontrado");
        if (!f.properties) f.properties = {};
        f.properties.estado = feature.properties.estado;

        const nuevoContent = btoa(unescape(encodeURIComponent(JSON.stringify(datos, null, 2))));

        const put = await fetch(`https://api.github.com/repos/${REPO}/contents/${PATH}`, {
            method: 'PUT',
            headers: { Authorization: `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: `Lote ${id} → ${feature.properties.estado}`,
                content: nuevoContent,
                sha: info.sha,
                branch: BRANCH
            })
        });

        if (put.ok) {
            
            showToast("¡Guardado!", "#16a34a");
            btn.textContent = "GUARDADO";
            setTimeout(() => map.closePopup(), 800);
            setTimeout(recargarMapa, 300); 
        } else {
            showToast("Error al guardar", "#dc2626");
            btn.disabled = false;
            btn.textContent = "REINTENTAR";
        }
    } catch (e) {
        showToast("Error de red", "#dc2626");
        btn.disabled = false;
        btn.textContent = "REINTENTAR";
    }
}


let popupActual = null;

function abrirPopup(layer, feature) {

    if (popupActual) {
        map.closePopup(popupActual);
        popupActual = null;
    }

    const p = feature.properties || {};
    const estado = (p.estado || "Disponible").trim();


    if (estado === "No disponible") {
        popupActual = L.popup({ closeButton: false })
            .setLatLng(layer.getBounds().getCenter())
            .setContent('<div style="padding:20px;font-size:18px;text-align:center;font-weight:bold;">LOTE NO DISPONIBLE</div>')
            .openOn(map);
        return;
    }


    const id = p.id || feature.id;

    const titulo = p.manzana && p.lote ? `Mz: ${p.manzana} | Lote: ${p.lote}` : `Lote ID: ${id}`;

    popupActual = L.popup({ closeOnClick: false, autoClose: false })
        .setLatLng(layer.getBounds().getCenter())
        .setContent(`
            <div class="custom-popup">
                <div style="text-align:center;font-size:22px;font-weight:bold;margin-bottom:10px;">${titulo}</div>
                <div style="margin:15px 0;font-size:16px;">Estado actual: <strong>${estado}</strong></div>
                <select id="nuevoEstado">
                    <option value="Disponible" ${estado==='Disponible'?'selected':''}>Disponible</option>
                    <option value="Adjudicado" ${estado==='Adjudicado'?'selected':''}>Adjudicado</option>
                </select>
                <button id="btnGuardar">OK</button>
            </div>
        `)
        .openOn(map);


    document.getElementById("btnGuardar").onclick = async () => {
        const nuevo = document.getElementById("nuevoEstado").value;
        if (nuevo === estado) {
            map.closePopup(popupActual);
            popupActual = null;
            return;
        }
        feature.properties.estado = nuevo;
        await guardarLote(feature, document.getElementById("btnGuardar"));
    };
}


async function cargarLotes() {
    await recargarMapa();
    map.fitBounds(lotesLayer.getBounds(), { padding: [50, 50] });
}

cargarLotes();
setInterval(recargarMapa, 6000);


map.getContainer().addEventListener('click', function(e) {
    if (e.target !== map.getContainer()) return;
    if (popupActual) {
        map.closePopup(popupActual);
        popupActual = null;
    }
});

</script>
</body>
</html>